<div class="header bg-primary pb-6">
    <div class="container-fluid">
      <div class="header-body">
        <div class="row align-items-center py-4">
          <div class="col-lg-6 col-7">
            <h6 class="h2 text-white d-inline-block mb-0">Home</h6>
            <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
              <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
                <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                <!-- <li class="breadcrumb-item active" aria-current="page">Home</li> -->
              </ol>
            </nav>
          </div>
          <div class="col-lg-6 col-5 text-right">
            <a href="/add-post" class="btn btn-sm btn-neutral">New Post</a>
          </div>
        </div>
        <!-- Card stats -->
        <div class="row">
          <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
              <!-- Card body -->
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">All Visitors</h5>
                    <span class="h2 font-weight-bold mb-0"><%= visitorCount %></span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                      <i class="fa fa-eye"></i>
                    </div>
                  </div>
                </div>
                <p class="mt-3 mb-0 text-sm">
                  <% if(visitorsPercentageChange > 0) { %>
                    <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> <%= visitorsPercentageChange %>%</span>
                <% } else if(visitorsPercentageChange < 0) { %>
                    <span class="text-danger mr-2"><i class="fa fa-arrow-down"></i> <%= Math.abs(visitorsPercentageChange) %>%</span>
                <% } else { %>
                    <span class="text-primary mr-2"><i class="fa fa-minus"></i> <%= visitorsPercentageChange %>%</span>
                <% } %>
                  <span class="text-nowrap">Since last month</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
              <!-- Card body -->
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Donations</h5>
                    <span class="h2 font-weight-bold mb-0">2,356</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                      <i class="ni ni-money-coins"></i>
                    </div>
                  </div>
                </div>
                <p class="mt-3 mb-0 text-sm">
                  <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> 3.48%</span>
                  <span class="text-nowrap">Since last month</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
              <!-- Card body -->
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">All Messages</h5>
                    <span class="h2 font-weight-bold mb-0"><%= messageCount %></span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                      <i class="fas fa-envelope"></i>
                    </div>
                  </div>
                </div>
                <p class="mt-3 mb-0 text-sm">
                  <!-- <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> 3.48%</span> -->
                  <% if(messagesPercentageChange > 0) { %>
                    <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> <%= messagesPercentageChange %>%</span>
                <% } else if(messagesPercentageChange < 0) { %>
                    <span class="text-danger mr-2"><i class="fa fa-arrow-down"></i> <%= Math.abs(messagesPercentageChange) %>%</span>
                <% } else { %>
                    <span class="text-primary mr-2"><i class="fa fa-minus"></i> <%= messagesPercentageChange %>%</span>
                <% } %>
                  <span class="text-nowrap">Since last month</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-md-6">
            <div class="card card-stats">
              <!-- Card body -->
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">Performance</h5>
                    <span class="h2 font-weight-bold mb-0">49,65%</span>
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                      <i class="ni ni-chart-bar-32"></i>
                    </div>
                  </div>
                </div>
                <p class="mt-3 mb-0 text-sm">
                  <span class="text-success mr-2"><i class="fa fa-arrow-up"></i> 3.48%</span>
                  <span class="text-nowrap">Since last month</span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Page content -->
  <div class="container-fluid mt--6">
    <div class="row">
      <div class="col-xl-6">
        <div class="card bg-default">
          <div class="card-header bg-transparent">
            <div class="row align-items-center">
              <div class="col">
                <h6 class="text-light text-uppercase ls-1 mb-1">Overview</h6>
                <h5 class="h3 text-white mb-0">Visitors</h5>
              </div>
              <div class="col">
                <ul class="nav nav-pills justify-content-end">
                  <li class="nav-item mr-2 mr-md-0" data-toggle="chart">
                    <a href="#" class="days nav-link py-2 px-3 active" data-toggle="tab">
                      <span class="d-none d-md-block">Last 10 days</span>
                      <span class="d-md-none">M</span>
                    </a>
                  </li>
                  <li class="nav-item" data-toggle="chart">
                    <a href="#" class="year nav-link py-2 px-3" data-toggle="tab">
                      <span class="d-none d-md-block">This year</span>
                      <span class="d-md-none">W</span>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Chart -->
            <div class="chart">
              <!-- Chart wrapper -->
              <!-- <canvas id="chart-sales-dark" class="chart-canvas"></canvas> -->
              <canvas id="chart-visitors-dark" class="chart-canvas"></canvas>

            </div>
          </div>
        </div>
      </div>
      <div class="col-xl-6">
        <div class="card">
          <div class="card-header bg-transparent">
            <div class="row align-items-center">
              <div class="col">
                <h6 class="text-uppercase text-muted ls-1 mb-1">Performance</h6>
                <h5 class="h3 mb-0">Total orders</h5>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Chart -->
            <div class="chart">
              <canvas id="chart-bars" class="chart-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xl-6">
        <div class="card">
          <div class="card-header border-0">
            <div class="row align-items-center">
              <div class="col">
                <h3 class="mb-0">Page visits</h3>
              </div>
              <div class="col text-right">
                <!-- <a href="#!" class="btn btn-sm btn-primary">See all</a> -->
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <!-- Projects table -->
            <% if(visitorsCurrentUrl != ''){ %>
            <table class="table align-items-center table-flush">
              <thead class="thead-light">
                <tr>
                  <th scope="col">Page name</th>
                  <th scope="col">Visitors</th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody>
                <% visitorsCurrentUrl.forEach((currenturl) => { let percentage = (currenturl.count / visitorsTotalCount) * 100; %> %>
                <tr>
                  <th scope="row">
                    <%= currenturl._id %>
                  </th>
                  <td>
                    <%= currenturl.count %>
                  </td>
                  <td>
                  <div class="d-flex align-items-center">
                      <span class="mr-2"><%= percentage.toFixed(2) %>%</span>
                      <div>
                        <div class="progress">
                          <div class="progress-bar bg-gradient-primary" role="progressbar" aria-valuenow="<%= percentage.toFixed(2) %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= percentage.toFixed(2) %>%;"></div>
                        </div>
                      </div>
                    </div>
                  </td>
                  <% }) %>
                </tr>
              </tbody>
            </table>
            <% } else { %>
              <h1 class="text-center text-primary">No Url Found</h1>
            <% } %>
          </div>
        </div>
      </div>
      <div class="col-xl-6">
        <div class="card">
          <div class="card-header border-0">
            <div class="row align-items-center">
              <div class="col">
                <h3 class="mb-0">Social traffic</h3>
              </div>
              <div class="col text-right">
                <!-- <a href="#!" class="btn btn-sm btn-primary">See all</a> -->
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <!-- Projects table -->
            <% if(visitorsReferrer != ''){ %>
            <table class="table align-items-center table-flush">
              <thead class="thead-light">
                <tr>
                  <th scope="col">Referral</th>
                  <th scope="col">Visitors</th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody>
                <% visitorsReferrer.forEach((row, index) => { let percentage = (row.count / visitorsTotalCount) * 100; %> %>
                <tr>
                  <th scope="row">
                    <%= row._id %>
                  </th>
                  <td>
                    <%= row.count %>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <span class="mr-2"><%= percentage.toFixed(2) %>%</span>
                      <div>
                        <div class="progress">
                          <div class="progress-bar bg-gradient-primary" role="progressbar" aria-valuenow="<%= percentage.toFixed(2) %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= percentage.toFixed(2) %>%;"></div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
                <% }) %>
              </tbody>
            </table>
            <% } else { %>
              <h1 class="text-center text-primary">No Referrer Found</h1>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    let ctx = document.getElementById('chart-visitors-dark').getContext('2d');
    let myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: ' Visitors',
                data: [],
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                tension: 0.4
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function(value, index, values) {
                          if (value % 1 === 0) {
                              return value;
                          }
                      }
                  }
                }
            }
        }
    });

    function fetchDaysData() {
      fetch('/visitor-days-data')
      .then(response => response.json())
      .then(data => {
          let dates = data.dates.map(item => item || 0);
          let dayData = data.dayData.map(item => item || 0);
          
          myChart.data.labels = dates;
          myChart.data.datasets[0].data = dayData;
          myChart.update();
      })
      .catch(error => console.error('Error:', error));
    }

    function fetchYearData() {
      fetch('/visitor-year-data')
      .then(response => response.json())
      .then(data => {
          let yearData = data.monthData.map(item => item || 0);
          
          myChart.data.labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          myChart.data.datasets[0].data = yearData;
          myChart.update();
      })
      .catch(error => console.error('Error:', error));
    }

    document.querySelector('.days').addEventListener('click', () => fetchDaysData());
    document.querySelector('.year').addEventListener('click', () => fetchYearData());

    fetchDaysData();
</script>